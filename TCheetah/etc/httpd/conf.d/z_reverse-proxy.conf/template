LoadModule auth_cas_module modules/mod_auth_cas.so

<IfModule mod_auth_cas.c>
    CASCookiePath /var/cache/mod_auth_cas/
    CASValidateURL https://sso.bris.ac.uk/sso/serviceValidate
    CASLoginURL https://sso.bris.ac.uk/sso/login
    CASCertificatePath /etc/httpd/CAs/
</IfModule>

Listen 5984
Listen 5986
Listen 50070
Listen 50030
Listen 58080

Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED
<Proxy balancer://bigcouch>
BalancerMember http://bc-37-00.dice.cluster:5984 route=1
BalancerMember http://bc-37-01.dice.cluster:5984 route=2
BalancerMember http://bc-37-02.dice.cluster:5984 route=3
ProxySet stickysession=ROUTEID
</Proxy>

<Proxy balancer://bigcouch-admin>
BalancerMember http://bc-37-00.dice.cluster:5986 route=1
BalancerMember http://bc-37-01.dice.cluster:5986 route=2
BalancerMember http://bc-37-02.dice.cluster:5986 route=3
ProxySet stickysession=ROUTEID
</Proxy>

<VirtualHost *:58080>
#if 'io-37-00' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-00.acrc.bris.ac.uk
   ServerName dice-io-37-00.acrc.bris.ac.uk
#elif 'io-37-01' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-01.acrc.bris.ac.uk
   ServerName dice-io-37-01.acrc.bris.ac.uk
#else
   ServerAdmin webmaster@$self.metadata.hostname
   ServerName $self.metadata.hostname
#end if
   DocumentRoot "/opt/websites/web/www/dummy"
   AllowEncodedSlashes On
   ProxyRequests Off
   KeepAlive Off
   <Proxy *>
      Order deny,allow
      Deny from all
      Allow from .phy.bris.ac.uk .dice.cluster
   </Proxy>
   ProxyPass / http://vm-ci.dice.cluster:8080 nocanon
   ProxyPassReverse / http://vm-ci.dice.cluster:8080
   ErrorLog "logs/ci-access_log"
   CustomLog "logs/ci-error_log" common
</VirtualHost>

<VirtualHost *:5984>
#if 'io-37-00' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-00.acrc.bris.ac.uk
   ServerName dice-io-37-00.acrc.bris.ac.uk
#elif 'io-37-01' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-01.acrc.bris.ac.uk
   ServerName dice-io-37-01.acrc.bris.ac.uk
#else
   ServerAdmin webmaster@$self.metadata.hostname
   ServerName $self.metadata.hostname
#end if
   DocumentRoot "/opt/websites/web/www/dummy"
   AllowEncodedSlashes On
   ProxyRequests Off
   KeepAlive Off
   <Proxy *>
      Order deny,allow
      Deny from all
      Allow from .phy.bris.ac.uk .dice.cluster
   </Proxy>
   ProxyPass /_users balancer://bigcouch-admin/_users nocanon
   ProxyPass / balancer://bigcouch/ nocanon
   ProxyPassReverse / balancer://bigcouch/
   ErrorLog "logs/bc-access_log"
   CustomLog "logs/bc-error_log" common
</VirtualHost>

<VirtualHost *:5986>
#if 'io-37-00' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-00.acrc.bris.ac.uk
   ServerName dice-io-37-00.acrc.bris.ac.uk
#elif 'io-37-01' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-01.acrc.bris.ac.uk
   ServerName dice-io-37-01.acrc.bris.ac.uk
#else
   ServerAdmin webmaster@$self.metadata.hostname
   ServerName $self.metadata.hostname
#end if
   DocumentRoot "/opt/websites/web/www/dummy"
   AllowEncodedSlashes On
   ProxyRequests Off
   KeepAlive Off
   <Proxy *>
      Order deny,allow
      Deny from all
      Allow from .phy.bris.ac.uk .dice.cluster
   </Proxy>
   ProxyPass / balancer://bigcouch-admin/ nocanon
   ProxyPassReverse / balancer://bigcouch-admin/
   ErrorLog "logs/bc-admin-access_log"
   CustomLog "logs/bc-admin-error_log" common
</VirtualHost>

<VirtualHost *:50070>
#if 'io-37-00' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-00.acrc.bris.ac.uk
   ServerName dice-io-37-00.acrc.bris.ac.uk
#elif 'io-37-01' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-01.acrc.bris.ac.uk
   ServerName dice-io-37-01.acrc.bris.ac.uk
#else
   ServerAdmin webmaster@$self.metadata.hostname
   ServerName $self.metadata.hostname
#end if
   DocumentRoot "/opt/websites/web/www/dummy"
   ProxyRequests Off
   <Proxy *>
      AuthType CAS
      AuthGroupFile /etc/httpd/conf/group
      Require group hadoop
      CASScope /
      Order deny,allow
      Deny from all
      Allow from .phy.bris.ac.uk .dice.cluster
   </Proxy>
   ProxyPass / http://nn-37-00.dice.cluster:50070 nocanon
   ProxyPassReverse / http://nn-37-00.dice.cluster:50070
   ErrorLog "logs/hadoop-nn-access_log"
   CustomLog "logs/hadoop-nn-error_log" common
</VirtualHost>

<VirtualHost *:50030>
#if 'io-37-00' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-00.acrc.bris.ac.uk
   ServerName dice-io-37-00.acrc.bris.ac.uk
#elif 'io-37-01' in $self.metadata.hostname
   ServerAdmin webmaster@dice-io-37-01.acrc.bris.ac.uk
   ServerName dice-io-37-01.acrc.bris.ac.uk
#else
   ServerAdmin webmaster@$self.metadata.hostname
   ServerName $self.metadata.hostname
#end if
   DocumentRoot "/opt/websites/web/www/dummy"
   ProxyRequests Off
   <Proxy *>
      AuthType CAS
      AuthGroupFile /etc/httpd/conf/group
      Require group hadoop
      CASScope /
      Order deny,allow
      Deny from all
      Allow from .phy.bris.ac.uk .dice.cluster
   </Proxy>
   ProxyPass / http://nn-37-00.dice.cluster:50030 nocanon
   ProxyPassReverse / http://nn-37-00.dice.cluster:50030
   ErrorLog "logs/hadoop-jt-access_log"
   CustomLog "logs/hadoop-jt-error_log" common
</VirtualHost>